var RAL={debug:!1};RAL.Heap=function(){this.items=[]},RAL.Heap.prototype={getNextHighestPriority:function(){var e=1;return this.items[0]&&(e=this.items[0].priority+1),e},parentIndex:function(e){return Math.floor(.5*e)},leftChildIndex:function(e){return 2*e},rightChildIndex:function(e){return 2*e+1},get:function(e){var t=null;return e>=1&&this.items[e-1]&&(t=this.items[e-1]),t},set:function(e,t){this.items[e-1]=t},swap:function(e,t){var i=this.get(e);this.set(e,this.get(t)),this.set(t,i)},upHeap:function(e){var t=null,i=null,n=null,o=!1;do o=!1,n=this.parentIndex(e),t=this.get(e),i=this.get(n),o=null!==i&&t.priority>i.priority,o&&(this.swap(e,n),e=n);while(o)},downHeap:function(e){var t=null,i=null,n=null,o=null,s=null,r=null,l=!1;do l=!1,o=this.leftChildIndex(e),s=this.rightChildIndex(e),t=this.get(e)&&this.get(e).priority,i=this.get(o)&&this.get(o).priority,n=this.get(s)&&this.get(s).priority,null===i&&(i=Number.NEGATIVE_INFINITY),null===n&&(n=Number.NEGATIVE_INFINITY),r=Math.max(i,n),r>t&&(n===r?(this.swap(e,s),e=s):(this.swap(e,o),e=o),l=!0);while(l)},add:function(e){this.items.push(e),this.upHeap(this.items.length)},remove:function(){var e=null;return this.items.length&&(this.swap(1,this.items.length),e=this.get(this.items.length),this.items.length-=1,this.downHeap(1)),e}},RAL.Sanitiser=function(){function e(e){return e.replace(/.*?:\/\//,"",e)}return{cleanURL:e}}(),RAL.CacheParser=function(){function e(e){var t=/max\-age=(\d+)/gi,i=/Cache-Control:.*?no\-cache/gi,n=/Cache-Control:.*?no\-store/gi,o=/Cache-Control:.*?must\-revalidate/gi,s=/Expires:\s(.*)/gi,r=[],l=t.exec(e),a=Date.now();return n.test(e)&&r.push("Cache-Control: no-store is set"),i.test(e)&&r.push("Cache-Control: no-cache is set"),o.test(e)&&r.push("Cache-Control: must-revalidate is set"),null!==l?a=Date.now()+1e3*l[1]:(l=s.exec(e),null!==l?a=Date.parse(l[1]):r.push("Cache-Control: max-age and Expires: headers are not set")),{headers:e,cacheable:0===r.length,useBy:a,warnings:r}}return{parse:e}}(),RAL.FileSystem=function(){function e(){return a}function t(e){c.push(e)}function i(e,t,i){a&&(e=RAL.Sanitiser.cleanURL(e),h.getFile(e,{},function(e){t(e.toURL())},i))}function n(e,t,i){a&&(e=RAL.Sanitiser.cleanURL(e),h.getFile(e,{},function(e){e.file(function(e){var i=new FileReader;i.onloadend=function(){t(this.result)},i.readAsText(e)})},i))}function o(e,t,i){if(console.log("FileSystem set called"),a){e=RAL.Sanitiser.cleanURL(e);var n=e.split("/");n.pop(),n=["cache"].concat(n),console.log("Setting the directory path"),console.log("Directory path is ",n),s(h,n,function(){console.log("Created the directories"),h.getFile(e,{create:!0},function(e){e.createWriter(function(n){n.onwriteend=function(){n.onwriteend=function(){i(e.toURL())},n.truncate(t.size)},n.onerror=function(e){console.warn("Write failed: "+e.toString())},console.log("Writing the file to the filesystem"),n.write(t)},d.onError)},d.onError)})}}function s(e,t,i){("."===t[0]||""===t[0])&&(t=t.slice(1)),t.length?e.getDirectory(t[0],{create:!0},function(e){t.length&&s(e,t.slice(1),i)},d.onError):i()}function r(e,t,i){a&&h.getDirectory(e,{},function(e){e.removeRecursively(t,d.onError)},i||d.onError)}function l(e,t,i){a&&h.getFile(e,{},function(e){e.remove(t,d.onError)},i||d.onError)}var a=!1,c=[],h=null,d={onError:function(e){var t="";switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:t="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:t="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:t="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:t="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:t="INVALID_STATE_ERR";break;default:t="Unknown Error"}console.error("Error: "+t,e)},onInitialised:function(e){if(h=e.root,console.log("root is ",h),console.log("Add all files in the cache directory"),a=!0,c.length)for(var t=c.length;t--;)c[t]()}};return function(e){e=e||10,window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.resolveLocalFileSystemURL=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL,window.requestFileSystem&&window.requestFileSystem(window.TEMPORARY,1024*1024*e,d.onInitialised,d.onError)}(),{isReady:e,registerOnReady:t,getPath:i,getDataAsText:n,set:o,removeFile:l,removeDir:r}}(),RAL.FileManifest=function(){function e(){return h}function t(e){d.push(e)}function i(e,t){var i=RAL.Sanitiser.cleanURL(e),n=c[i]||null;t(n)}function n(e,t,i){var n=RAL.Sanitiser.cleanURL(e);c[n]=t,l(i)}function o(){c={},l()}function s(){r("{}")}function r(e){if(h=!0,c=JSON.parse(e),d.length)for(var t=d.length;t--;)d[t]()}function l(e){var t=new Blob([JSON.stringify(c)],{type:"application/json"});RAL.FileSystem.set("manifest.json",t,function(){e&&e()})}function a(){RAL.FileSystem.getDataAsText("manifest.json",r,s)}var c=null,h=!1,d=[];return RAL.FileSystem.isReady()?a():RAL.FileSystem.registerOnReady(a),{isReady:e,registerOnReady:t,get:i,set:n,reset:o}}(),RAL.RemoteFile=function(){},RAL.RemoteFile.prototype={element:null,src:null,autoLoad:!1,ignoreCacheHeaders:!1,timeToLive:12096e5,priority:0,loaded:!1,wURL:window.URL||window.webkitURL,callbacks:{onCacheError:function(e){e.src=this.src,this.sendEvent("cacheerror",e)},onRemoteFileLoaded:function(e,t){if(console.log("Remote file loaded",e,t),this.ignoreCacheHeaders&&(t.cacheable=!0,t.useBy+=this.timeToLive),t.cacheable)console.log("Writing to the filesystem"),RAL.FileSystem.set(this.src,e,this.callbacks.onFileSystemSet.bind(this,t));else{console.log("Local file");var i=this.wURL.createObjectURL(e);this.callbacks.onLocalFileLoaded.call(this,i),this.callbacks.onCacheError.call(this,t)}this.sendEvent("remoteloaded",t)},onRemoteFileUnavailable:function(){this.sendEvent("remoteunavailable")},onLocalFileLoaded:function(e){this.loaded=!0,this.sendEvent("loaded",e)},onLocalFileUnavailable:function(){this.showPlaceholder(),this.loadFromRemote(),this.sendEvent("localunavailable")},onFileSystemSet:function(e){RAL.FileManifest.set(this.src,e,this.callbacks.onFileManifestSet.bind(this))},onFileManifestSet:function(){this.load()},onFileManifestGet:function(e){var t=Date.now();null!==e?e.useBy>t||!RAL.NetworkMonitor.isOnline()?RAL.FileSystem.getPath(this.src,this.callbacks.onLocalFileLoaded.bind(this),this.callbacks.onLocalFileUnavailable.bind(this)):this.loadFromRemote():this.loadFromRemote()}},sendEvent:function(e,t){this.checkForElement();var i=document.createEvent("Event");i.initEvent(e,!0,!0),t&&(i.data=t),this.element.dispatchEvent(i)},loadFromRemote:function(){RAL.Loader.load(this.src,this.headers,"blob",this.callbacks.onRemoteFileLoaded.bind(this),this.callbacks.onRemoteFileUnavailable.bind(this)),this.sendEvent("remoteloadstart")},load:function(){RAL.FileManifest.get(this.src,this.callbacks.onFileManifestGet.bind(this))},checkForElement:function(){this.element||(this.element=document.createElement("span"))},addEventListener:function(e,t,i){this.checkForElement(),this.element.addEventListener(e,t,i)}},RAL.RemoteImage=function(e){RAL.RemoteFile.call(this),e=e||{},console.log("This is a custom build of RAL"),this.element=e.element||document.createElement("img"),this.src=this.element.dataset.src||e.src,this.width=this.element.width||e.width||null,this.height=this.element.height||e.height||null,this.placeholder=this.element.dataset.placeholder||null,this.headers=e.headers||[],this.priority=e.priority||0,this.addEventListener("remoteloadstart",this.showPlaceholder.bind(this)),this.addEventListener("loaded",this.showImage.bind(this)),"undefined"!=typeof e.autoLoad&&(this.autoLoad=e.autoLoad),"undefined"!=typeof e.ignoreCacheHeaders&&(this.ignoreCacheHeaders=e.ignoreCacheHeaders),this.ignoreCacheHeaders&&"undefined"!=typeof this.timeToLive&&(this.timeToLive=e.timeToLive),this.autoLoad?this.load():this.showPlaceholder()},RAL.RemoteImage.prototype=new RAL.RemoteFile,RAL.RemoteImage.prototype.showPlaceholder=function(){null!==this.placeholder&&(this.element.style["-webkit-transition"]="background-image 0.5s ease-out",this.showImage({data:this.placeholder}))},RAL.RemoteImage.prototype.showImage=function(e){var t=e.data,i=new Image,n=function(e){this.wURL.revokeObjectURL(e)}.bind(this,t),o=function(){var e=this.width||i.naturalWidth,o=this.height||i.naturalHeight;this.element.style.width=e+"px",this.element.style.height=o+"px",this.element.style.backgroundImage="url("+t+")",this.element.style.backgroundSize=e+"px "+o+"px",/blob:/.test(t)&&setTimeout(n,100)};i.onload=o.bind(this),i.src=t},RAL.Loader=function(){function e(e,t,i,n){e.abort(),this.load(t,i,n)}function t(n,o,s,r,l){if(RAL.NetworkMonitor.isOnline()){var a=new XMLHttpRequest;a.responseType=s,a.onerror=i.onError.bind(this,l),a.onload=i.onLoad.bind(this,n,r,l),console.log("Setting Authorization header"),a.open("GET",n,!0);for(var c=0;c<o.length;c++)a.setRequestHeader(o[c].name,o[c].value);a.send(),RAL.NetworkMonitor.registerForOffline(e.bind(this,a,n,r,l))}else RAL.NetworkMonitor.registerForOnline(t.bind(this,n,r,l))}var i={onLoad:function(e,t,i,n){var o=n.target,s=o.response,r=RAL.CacheParser.parse(o.getAllResponseHeaders());4===o.readyState&&(200===o.status?(console.log("Writing the file to the file system"),t(s,r)):i(n))},onError:function(e,t){e(t)}};return{load:t}}(),RAL.NetworkMonitor=function(){function e(e){n.push(e)}function t(e){o.push(e)}function i(){return window.navigator.onLine}var n=[],o=[];return window.addEventListener("online",function(){for(var e=n.length,t=null;e--;)t=n.pop(),t()}),window.addEventListener("offline",function(){for(var e=o.length,t=null;e--;)t=o.pop(),t()}),{registerForOnline:e,registerForOffline:t,isOnline:i}}(),RAL.Queue=function(){function e(){return s.getNextHighestPriority()}function t(e){l=e}function i(e,t){"undefined"==typeof e.priority&&(e.priority=s.getNextHighestPriority()),s.add(e),t&&n()}function n(){for(;l>r;){if(nextFile=s.remove(),null===nextFile){RAL.debug&&console.log("[Connections: "+r+"] - No more images queued");break}nextFile.addEventListener("loaded",a.onFileLoaded),nextFile.load(),RAL.debug&&console.log("[Connections: "+r+"] - Loading "+nextFile.src),r++}}function o(){s.clear()}var s=new RAL.Heap,r=0,l=6,a={onFileLoaded:function(){RAL.debug&&console.log("[Connections: "+r+"] - File loaded"),r--,n()}};return{getNextHighestPriority:e,setMaxConnections:t,add:i,clear:o,start:n}}();//@ sourceMappingURL=ral.map